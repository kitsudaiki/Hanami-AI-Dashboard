<!-- Apache License Version 2.0

Copyright 2020 Tobias Anker

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License. -->

<!--=============================================================================-->
<!--                                content                                      -->
<!--=============================================================================-->

<svg width="100%" height="68">
    <polygon class="hexagon_field header_label_position" points="285,0 300,21 285,42 15,42 0,21 15,0"></polygon>
    <text x="70" y="27"  class="header_label_position" font-size="20px">Segment Template</text>
</svg>

<div class="tile_div">
    <table align = "center" id="table" border="1"></table>
</div>

<!--=============================================================================-->
<!--                              delete modal                                   -->
<!--=============================================================================-->

<div id="delete_modal" class="modal">
    <div id="delete_modal_content" class="modal_content">
        <div class="modal_header_part">
            <svg width="100%" height="68" class="modal_header_position">
                <polygon class="hexagon_field header_label_position " points="285,0 300,21 285,42 15,42 0,21 15,0"></polygon>
                <text x="35" y="27"  class="header_label_position" font-size="20px">Delete Segment Template</text>
            </svg>
        </div>
        <div id="delete_modal_content_part" class="modal_content_part">
            <center>
                <br><br>
                Do you really want to delete segment template:
                <br><br><br>
                <h2><label id="delete_label_text"></label></h2>
            </center>
        </div>
        <div class="modal_footer_part">
            <center>
                <img id="modal_delete_accept_button" class="generic_svg_button" src="/client/icons/uberprufen.svg">
                <img id="modal_delete_cancel_button" class="generic_svg_button" src="/client/icons/kreuzen.svg">
            </center>
        </div>
    </div>
</div>

<!--=============================================================================-->
<!--                                 style                                       -->
<!--=============================================================================-->

<style>
    #create_modal_content { 
        color: var(--color-text);
        width: 35rem;
        height: 15rem;
    }

    #delete_modal_content { 
        color: var(--color-text);
        width: 20rem;
        height: 17rem;
    }

    #input_fields {
        width: 33rem;
        margin: auto;
        margin-top: 2rem;
        margin-bottom: 2rem;
    }

    .input_field {
        width: 20rem;
        height: 20rem;
    }

    #delete_label_text {
        vertical-align:middle;
        text-align:center;
        width: 20rem;
    }

    #delete_modal_content_part {
        height: 10rem;
    }

    #modal_create_accept_button {
        margin-right: 10rem;
    }

    #modal_delete_accept_button {
        margin-right: 5rem;
    }

    .modal_error_field {
        color: red;
        width: 10rem;
    }

    .header_label_position {
        transform: translate(calc(50% - 150px), 0%);
    }

    label {
        white-space: pre-wrap;  /* to allow multi-line lables */
        display: inline-block;
        width: 5rem;
        text-align: left;
    }

</style>

<!--=============================================================================-->
<!--                                 script                                      -->
<!--=============================================================================-->

<script src="/client/scripts/table_processing.js"></script>
<script src="/client/scripts/common.js"></script>
<script>
    // mapping for segment-template-table
    var headerMapping = new Map();
    headerMapping.set("uuid", "UUID");
    headerMapping.set("visibility", "Visibility");
    headerMapping.set("name", "Name");
    headerMapping.set("type", "Type");

    // inital creation of the segment-template-list when open the window
    listSegmentSnapshost_request();

    /**
     * Send request to backend to get a list of all segment-template
     */
    function listSegmentSnapshost_request()
    {
        const token = getAndCheckToken();
        if(token == "") {
            return;
        }

        const request = "/control/kyouko/v1/template/all?type=segment";

        var segmentTemplateListConnection = new XMLHttpRequest();
        segmentTemplateListConnection.open("GET", request, true);
        segmentTemplateListConnection.setRequestHeader("X-Auth-Token", token);

        segmentTemplateListConnection.onload = function(e) 
        {
            if(segmentTemplateListConnection.status != 200) {
                return false;
            }

            const jsonContent = JSON.parse(segmentTemplateListConnection.responseText);
            constructTable(jsonContent, headerMapping, '#table');
        };
        segmentTemplateListConnection.onerror = function(e) 
        {
            console.log("Failed to load list of segment-templates.");
        };

        segmentTemplateListConnection.send(null);
    }

    function sendFile(websocket, file, uuid, fileUuid)
    {
        var segmentSize = 42 * 1024;
        let counter = 0;
        var fileSize = (file.size - 1);

        for(let start = 0; start < fileSize; start += segmentSize) 
        {
            var reader = new FileReader();
            var blob = file.slice(start, segmentSize + start);

            reader.onload = function(e) {
                // get reeader-result and cut unnecessary header of the resulting string
                const msg = uuid + "," + fileUuid + "," + start + "," + e.target.result.split(',')[1];
                websocket.send(msg);
                counter = counter + 1;
            };

            // read as DataURL instead of array-buffer, because the javascript websocket seems to have problems with plain raw-data
            reader.readAsDataURL(blob);
        }

        return true;
    }

    /**
     * Create and send request to delete a segment-template from the list
     *
     * @param {name} Name of the segment-template to delete
     */
    function DeleteSegmentSnapshost_Request(name)
    {
        const token = getAndCheckToken();
        if(token == "") {
            return;
        }
        
        // create requeset
        const request = "/control/sagiri/v1/segment_template?uuid=" + name;
        var segmentTemplateDeleteConnection = new XMLHttpRequest();
        segmentTemplateDeleteConnection.open("DELETE", request, true);
        segmentTemplateDeleteConnection.setRequestHeader("X-Auth-Token", token);

        // callback for success
        segmentTemplateDeleteConnection.onload = function(e) 
        {
            if(segmentTemplateDeleteConnection.status != 200) {
                return;
            }

            listSegmentTemplate_request();
            var modal = document.getElementById("delete_modal");
            modal.style.display = "none";
        };

        // callback for fail
        segmentTemplateDeleteConnection.onerror = function(e) 
        {
            console.log("Failed to delete segment-template.");
        };

        segmentTemplateDeleteConnection.send(null);
    }

    /**
     * Clear all fields of the segment-template-create-modal
     */
    function clearModalFields()
    {
        document.getElementById('name_field').value = "";
    }

    /**
     * Open segment-template-delete-modal to ask if segment-template should really be deleted.
     * This function is named 'deleteObject' instead of 'segment-template' because it is triggered
     * by the genric delete-button of the table, which is generated in a generic way.
     *
     * @param {name} Name of the dasegment-templatetaset to delete
     */
    function deleteObject(name)
    {
        var modal = document.getElementById("delete_modal");
        var acceptButton = document.getElementById("modal_delete_accept_button");
        var cancelButton = document.getElementById("modal_delete_cancel_button");

        document.getElementById('delete_label_text').innerText = name;

        // handle accept-button
        acceptButton.onclick = function() {
            DeleteSegmentSnapshost_Request(name);
        }

        // handle cancel-button
        cancelButton.onclick = function() {
            modal.style.display = "none";
        } 

        // handle click outside of the window
        window.onclick = function(event) 
        {
            if(event.target == modal) {
                modal.style.display = "none";
            }
        } 

        modal.style.display = "block";
    }
    
</script>
